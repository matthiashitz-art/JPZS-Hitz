<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Kurs-Info</title>

  <!-- Office.js laden -->
  <script src="https://appsforoffice.microsoft.com/lib/1/hosted/office.js"></script>

  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Arial, sans-serif;
      font-size: 13px;
      margin: 0;
      padding: 12px;
      background: #f3f4f6;
      color: #111827;
    }

    .panel {
      background: #ffffff;
      border-radius: 10px;
      padding: 12px 14px;
      box-shadow: 0 2px 6px rgba(15, 23, 42, 0.12);
      border: 1px solid #e5e7eb;
    }

    h1 {
      font-size: 14px;
      margin: 0 0 8px;
      padding-bottom: 6px;
      border-bottom: 1px solid #e5e7eb;
      display: flex;
      align-items: center;
      gap: 6px;
      color: #111827;
    }

    h1::before {
      content: "";
      width: 4px;
      height: 16px;
      border-radius: 999px;
      background: #2563eb;
    }

    .subline {
      font-size: 11px;
      color: #6b7280;
      margin-bottom: 8px;
    }

    .sections {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .section {
      padding: 6px 8px;
      border-radius: 8px;
      background: #f9fafb;
      border: 1px solid #e5e7eb;
    }

    .section-title {
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.04em;
      color: #6b7280;
      margin-bottom: 4px;
    }

    .info-row {
      display: flex;
      align-items: baseline;
      margin-bottom: 2px;
    }

    .info-row:last-child {
      margin-bottom: 0;
    }

    .label {
      font-weight: 600;
      font-size: 12px;
      color: #374151;
      min-width: 90px;
    }

    .value {
      font-size: 12px;
      color: #111827;
      flex: 1;
      word-break: break-word;
    }

    .empty-hint {
      color: #6b7280;
      font-style: italic;
      font-size: 11px;
      margin-top: 4px;
    }

    .error {
      color: #b91c1c;
      font-style: normal;
    }
  </style>
</head>
<body>
  <div class="panel">
    <h1><span id="title-bar">Kurs-Info</span></h1>
    <div class="subline" id="hint">
      Zellmarkierung in Spalte P oder rechts wählen.
    </div>
    <div id="info" class="empty-hint">
      Noch keine Kurszeile ausgewählt.
    </div>
  </div>

  <script>
    // Titel setzen (oben im Panel)
    function setTitle(title) {
      const el = document.getElementById("title-bar");
      if (!el) return;
      el.textContent = title && String(title).trim() !== "" ? String(title) : "Kurs-Info";
    }

    // Hinweis-/Statuszeile setzen
    function setHint(message) {
      const hint = document.getElementById("hint");
      if (!hint) return;
      hint.textContent = message;
    }

    // Panel leeren oder Hinweistext setzen
    function clearPanel(message) {
      const info = document.getElementById("info");
      if (!info) return;

      info.className = "empty-hint";
      info.textContent = message || "Keine Anzeige für diese Zelle.";
    }

    // Fehler-Text im Panel anzeigen
    function showError(message) {
      const info = document.getElementById("info");
      if (!info) return;

      info.className = "empty-hint error";
      info.textContent = "Fehler: " + message;
    }

    // Fehlerhandler: schreibt Fehlertext ins Panel
    function errorHandler(error) {
      console.error(error);
      let msg = "Unbekannter Fehler.";
      if (error && error.message) {
        msg = error.message;
      }
      if (error && error.debugInfo && error.debugInfo.errorLocation) {
        msg += " (Ort: " + error.debugInfo.errorLocation + ")";
      }
      showError(msg);
    }

    // Haupt-Handler bei Auswahländerung
    async function handleSelectionChanged(eventArgs) {
      try {
        await Excel.run(async (context) => {
          const workbook = context.workbook;

          // aktuelle Auswahl über das Workbook holen
          const range = workbook.getSelectedRange();
          range.load(["columnIndex", "rowIndex", "values"]);
          await context.sync();

          const colIndex = range.columnIndex; // 0-basiert (A=0, B=1, ..., P=15)
          const rowIndex = range.rowIndex;

          // 1) Nur ab Spalte P (Index 15) reagieren
          if (colIndex < 15) {
            setTitle("Kurs-Info");
            setHint("Zellmarkierung in Spalte P oder rechts wählen.");
            clearPanel("Noch keine passende Zelle ausgewählt.");
            return;
          }

          // 2) Nur anzeigen, wenn die gewählte Zelle Text enthält
          const cellValue = range.values[0][0];
          if (typeof cellValue !== "string" || cellValue.trim() === "") {
            setHint("Zelle enthält keinen Text – keine Detailanzeige.");
            setTitle("Kurs-Info");
            clearPanel("Für Zellen ohne Text wird nichts angezeigt.");
            return;
          }

          // 3) Daten der gleichen Zeile aus D:O holen (Werte + formatierten Text)
          const rowNumber = rowIndex + 1; // A1-Notation ist 1-basiert
          const sheet = workbook.worksheets.getActiveWorksheet();
          const rowRange = sheet.getRange(`D${rowNumber}:O${rowNumber}`);
          rowRange.load(["values", "text"]);
          await context.sync();

          const v = rowRange.values[0]; // rohe Werte
          const t = rowRange.text[0];   // formatiert wie in Excel angezeigt

          // D..O → Indexe:
          // 0=D, 1=E, 2=F, 3=G, 4=H, 5=I, 6=J, 7=K, 8=L, 9=M, 10=N, 11=O

          // Für die Anzeige nutzen wir die formatierten Texte (t[..]),
          // damit Datum / Zeit so aussehen wie im Excel-Format.
          const start       = t[0];  // D
          const ende        = t[1];  // E
          const dauer       = t[2];  // F
          const fachbereich = t[3];  // G
          const kursnummer  = t[4];  // H
          const kurs        = t[5];  // I
          const teilnehmer  = t[6];  // J
          const kursleiter  = t[7];  // K
          const freigabe    = t[8];  // L
          const rf          = t[9];  // M
          const fahrzeuge   = t[10]; // N
          const anlagen     = t[11]; // O

          // Titel oben: Kursname (Spalte I), sonst "Kurs-Info"
          setTitle(kurs);

          const info = document.getElementById("info");
          if (!info) return;

          const esc = (val) =>
            val === null || val === undefined || String(val).trim() === "" ? "-" : String(val);

          setHint(`Zeile ${rowNumber} · Ausgewählte Zelle enthält: "${cellValue}"`);

          info.className = "";
          info.innerHTML = `
            <div class="sections">

              <div class="section">
                <div class="section-title">Kurs</div>
                <div class="info-row">
                  <div class="label">Fachbereich</div>
                  <div class="value">${esc(fachbereich)}</div>
                </div>
                <div class="info-row">
                  <div class="label">Kursnummer</div>
                  <div class="value">${esc(kursnummer)}</div>
                </div>
                <div class="info-row">
                  <div class="label">Kurs</div>
                  <div class="value">${esc(kurs)}</div>
                </div>
              </div>

              <div class="section">
                <div class="section-title">Zeit</div>
                <div class="info-row">
                  <div class="label">Start</div>
                  <div class="value">${esc(start)}</div>
                </div>
                <div class="info-row">
                  <div class="label">Ende</div>
                  <div class="value">${esc(ende)}</div>
                </div>
                <div class="info-row">
                  <div class="label">Dauer</div>
                  <div class="value">${esc(dauer)}</div>
                </div>
              </div>

              <div class="section">
                <div class="section-title">Personen</div>
                <div class="info-row">
                  <div class="label">Kursleiter</div>
                  <div class="value">${esc(kursleiter)}</div>
                </div>
                <div class="info-row">
                  <div class="label">Teilnehmer</div>
                  <div class="value">${esc(teilnehmer)}</div>
                </div>
                <div class="info-row">
                  <div class="label">RF</div>
                  <div class="value">${esc(rf)}</div>
                </div>
              </div>

              <div class="section">
                <div class="section-title">Ressourcen</div>
                <div class="info-row">
                  <div class="label">Fahrzeuge</div>
                  <div class="value">${esc(fahrzeuge)}</div>
                </div>
                <div class="info-row">
                  <div class="label">Anlagen</div>
                  <div class="value">${esc(anlagen)}</div>
                </div>
                <div class="info-row">
                  <div class="label">Freigabe</div>
                  <div class="value">${esc(freigabe)}</div>
                </div>
              </div>

            </div>
          `;
        });
      } catch (error) {
        errorHandler(error);
      }
    }

    // Wird aufgerufen, wenn das Add-In bereit ist
    Office.onReady((info) => {
      if (info.host === Office.HostType.Excel) {
        Excel.run(async (context) => {
          const workbook = context.workbook;

          // prüfen, ob das Auswahl-Ereignis unterstützt wird
          if (!workbook.onSelectionChanged || !workbook.onSelectionChanged.add) {
            showError("Dieses Excel unterstützt 'workbook.onSelectionChanged' nicht.");
            return;
          }

          // Auswahl-Ereignis auf Workbook-Ebene registrieren
          workbook.onSelectionChanged.add(handleSelectionChanged);
          await context.sync();

          setTitle("Kurs-Info");
          clearPanel("Noch keine Kurszeile ausgewählt.");
        }).catch(errorHandler);
      }
    });
  </script>
</body>
</html>
